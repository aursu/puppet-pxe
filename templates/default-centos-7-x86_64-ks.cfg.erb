# Kickstart file automatically generated by anaconda.

install
url --url=http://<%= @install_server %>/centos/<%= @centos_version %>/os/x86_64

auth --enableshadow --passalgo=sha512
text
firstboot --disabled
ignoredisk --only-use=sda

lang en_US.UTF-8
keyboard --vckeymap=us --xlayouts='us'
timezone America/New_York --isUtc --nontp
bootloader --append=" crashkernel=auto rhgb quiet net.ifnames=0 biosdevname=0" --location=mbr --boot-drive=sda

network --onboot yes --device eth0 --bootproto dhcp --ipv6=auto
network --onboot yes --device eth1 --bootproto dhcp --nodns --noipv6

rootpw  --iscrypted $6$CbQ0irK3Ihe6GJYB$VgKlK75lqc1kZVnRCcwsFcBik.kfT3WdoW4FdTPDuMo/VOk4Wkxl.qr1JZb95hfbT28kANKLTNxUjb7OGNMEF.

firewall --disabled
selinux --disabled

# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
clearpart --all --drives=sda

part /boot --fstype="ext4" --size=488 --label=BOOT
part pv.008002 --fstype="lvmpv" --grow --size=1

volgroup vg0 --pesize=4096 pv.008002
logvol / --fstype=ext4 --name=lv_root --vgname=vg0 --size=2048
logvol /usr --fstype=ext4 --name=lv_usr --vgname=vg0 --size=5120
logvol /tmp --fstype=ext4 --name=lv_tmp --vgname=vg0 --size=1024
logvol /var --fstype=ext4 --name=lv_var --vgname=vg0 --grow --size=4096
logvol swap --name=lv_swap --vgname=vg0 --recommended

repo --name="base" --baseurl=http://<%= @install_server %>/centos/<%= @centos_version %>/os/x86_64 --cost=10
repo --name="extras" --baseurl=http://<%= @install_server %>/centos/<%= @centos_version %>/extras/x86_64 --cost=20
repo --name="updates" --baseurl=http://<%= @install_server %>/centos/<%= @centos_version %>/updates/x86_64 --cost=1

# Reboot after installation
reboot

%packages --ignoremissing --excludedocs --nocore --nobase
-@base
@core --nodefaults
%end

%post
for t in $(cat /proc/cmdline); do
    case $t in
        HOSTNAME*)
            eval $t
            break
        ;;
    esac
done

# disable installation process
if [ ! -z "$HOSTNAME" ]; then
    curl "http://<%= @install_server %>/exec/move.cgi?$HOSTNAME"
fi

# install authorized SSH keys for root user
curl http://<%= @install_server %>/ks/assets/root.authorized_keys -Dheaders -odata -s
if grep -q '200 OK' headers; then
    install -D -m600 data /root/.ssh/authorized_keys
fi

<% if @post_install_puppet_agent -%>
# install Puppet repository GPG key
curl <%= @rpm_gpg_key_url %> -Dheaders -odata -s
if grep -q '200 OK' headers; then
    install -D -m644 data <%= @rpm_gpg_key_path %>
    rpm --import <%= @rpm_gpg_key_path %>
fi

curl http://<%= @install_server %>/ks/assets/RPM-GPG-KEY-2025-04-06-puppet7-release -Dheaders -odata -s
if grep -q '200 OK' headers; then
    install -D -m644 data /etc/pki/rpm-gpg/RPM-GPG-KEY-2025-04-06-puppet7-release
    rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-2025-04-06-puppet7-release
fi

# install Puppet repository
curl <%= @puppet_repo_url %> -Dheaders -odata -s
if grep -q '200 OK' headers; then
    install -D -m644 data <%= @puppet_repo_path %>
fi

# install Puppet Agent
yum -y install puppet-agent-<%= @agent_version %>.el7

# install Puppet agent config
curl http://<%= @install_server %>/ks/assets/puppet.conf -Dheaders -odata -s
if grep -q '200 OK' headers; then
  install -D -m644 data /etc/puppetlabs/puppet/puppet.conf
fi

# bootstrap into Puppet
/opt/puppetlabs/bin/puppet agent --test
<% end -%>
%end

# Reboot after installation
reboot
